<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Image Gallery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: white;
        }

        .gallery-container {
            padding: 10px;
            max-width: 100vw;
            overflow-x: hidden;
        }

        .gallery-row {
            display: flex;
            margin-bottom: 8px;
            width: 100%;
        }

        .gallery-image {
            margin-right: 4px;
            cursor: pointer;
            transition: opacity 0.3s ease;
            object-fit: cover;
        }

        .gallery-image:last-child {
            margin-right: 0;
        }

        .gallery-image:hover {
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #ff6b6b;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #888;
            font-size: 1.1rem;
        }

        .stats {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Gallery</h1>
        <p>Responsive layout that adapts to window size</p>
    </div>

    <div class="stats" id="stats"></div>

    <div class="gallery-container" id="gallery">
        <div class="loading">Loading images...</div>
    </div>

    <script>
        let allImages = [];
        let galleryContainer = document.getElementById('gallery');
        let statsElement = document.getElementById('stats');

        // Fetch images from API
        async function loadImages() {
            try {
                const response = await fetch('/api/images');
                allImages = await response.json();

                if (allImages.length === 0) {
                    galleryContainer.innerHTML = '<div class="error">No images found. Please add some images to the static/images folder.</div>';
                    return;
                }

                updateStats();
                renderGallery();
            } catch (error) {
                console.error('Error loading images:', error);
                galleryContainer.innerHTML = '<div class="error">Error loading images. Please check the console for details.</div>';
            }
        }

        function updateStats() {
            statsElement.textContent = `${allImages.length} images â€¢ Window: ${window.innerWidth}x${window.innerHeight}px`;
        }

		// Logic to decide row height and items in row
        function calculateRows(viewWidth, imgList) {
			// Magic number 200; fix with config
            const targetRatio = viewWidth / 200;
            const rows = [];
            let lastImg = 0;

            while (lastImg < imgList.length) {
                let currRowCnt = 0;
                let prevRatioDiff = targetRatio;
                let currTotalRatio = 0;
                let colInRow = lastImg;

                for (let idx = lastImg; idx < imgList.length; idx++) {
                    currTotalRatio += imgList[idx].aspectRatio;

                    // Current ratio diff > previous
                    if (Math.abs(targetRatio - currTotalRatio) > prevRatioDiff) {
                        currTotalRatio -= imgList[idx].aspectRatio;

                        // If the single image is very wide
                        // Needed to prevent infinite loop
                        if (idx == lastImg) {
                            currTotalRatio = imgList[idx].aspectRatio;
                            colInRow = idx + 1;
                        } else {
                            colInRow = idx;
                        }
                        break;
                    }
                    prevRatioDiff = Math.abs(targetRatio - currTotalRatio);

                    // If we've reached the end of images
                    if (idx === imgList.length - 1) {
                        colInRow = idx + 1;
                        break;
                    }
                }

                // Same height for all img in row
				// Magic number
                const imgh = Math.max(85, viewWidth / currTotalRatio); // Min height of 100px

                // Create row data
                const rowImages = [];
                for (let i = lastImg; i < colInRow; i++) {
                    const imgw = (imgList[i].aspectRatio / currTotalRatio) * viewWidth;
                    rowImages.push({
                        ...imgList[i],
                        width: Math.max(50, imgw - 4), // Account for margin, min width
                        height: imgh
                    });
                }

                rows.push(rowImages);
                lastImg = colInRow;
            }

            return rows;
        }

        function renderGallery() {
            const viewWidth = window.innerWidth - 20; // Account for padding
            const rows = calculateRows(viewWidth, allImages);

            galleryContainer.innerHTML = '';

            rows.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'gallery-row';

                row.forEach(img => {
                    const imgElement = document.createElement('img');
                    imgElement.src = '/image/' + img.hash;
                    imgElement.className = 'gallery-image';
                    imgElement.style.width = img.width + 'px';
                    imgElement.style.height = img.height + 'px';
                    imgElement.alt = img.name;
                    imgElement.title = img.name;
					imgElement.loading = 'lazy';

                    // Add click handler for full size view
                    imgElement.addEventListener('click', () => {
                        window.open('/originalimage/'+img.hash, '_blank');
                    });

                    rowDiv.appendChild(imgElement);
                });

                galleryContainer.appendChild(rowDiv);
            });
        }

        // Debounced resize handler
        let resizeTimeout;
        function handleResize() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                updateStats();
                if (allImages.length > 0) {
                    renderGallery();
                }
            }, 150);
        }

        // Event listeners
        window.addEventListener('resize', handleResize);
        window.addEventListener('load', loadImages);

        // Load images immediately if DOM is already ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadImages);
        } else {
            loadImages();
        }
    </script>
</body>
</html>
